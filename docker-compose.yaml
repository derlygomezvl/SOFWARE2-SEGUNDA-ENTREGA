version: '3.8'

services:
  # API Gateway - Punto de entrada único al sistema
  gateway:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JWT_SECRET=${JWT_SECRET}
      - GATEWAY_PORT=8080
      - IDENTITY_URL=http://identity:8081
      - SUBMISSION_URL=http://submission:8082
      - NOTIFICATION_URL=http://notification:8083
      - GATEWAY_ENFORCE_ROLE_CHECK=true
      - GATEWAY_CONNECT_TIMEOUT=5000
      - GATEWAY_READ_TIMEOUT=30000
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    depends_on:
      identity:
        condition: service_healthy
      submission:
        condition: service_healthy
      notification:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/gateway/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Identity Service - Autenticación y gestión de usuarios
  identity:
    build:
      context: ./identity-service
      dockerfile: Dockerfile
    container_name: identity-service
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SERVER_PORT=8081
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=jdbc:postgresql://postgres-identity:5432/identity_db
      - DATABASE_USERNAME=${IDENTITY_DB_USER}
      - DATABASE_PASSWORD=${IDENTITY_DB_PASS}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-identity:
        condition: service_healthy
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Submission Service - Gestión de entregas y documentos
  submission:
    build:
      context: ./submission-service
      dockerfile: Dockerfile
    container_name: submission-service
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SERVER_PORT=8082
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=jdbc:postgresql://postgres-submission:5432/submission_db
      - DATABASE_USERNAME=${SUBMISSION_DB_USER}
      - DATABASE_PASSWORD=${SUBMISSION_DB_PASS}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
      - FILE_STORAGE_PATH=/app/uploads
    volumes:
      - submission-uploads:/app/uploads
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-submission:
        condition: service_healthy
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Notification Service - Envío de notificaciones
  notification:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SERVER_PORT=8083
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=jdbc:postgresql://postgres-notification:5432/notification_db
      - DATABASE_USERNAME=${NOTIFICATION_DB_USER}
      - DATABASE_PASSWORD=${NOTIFICATION_DB_PASS}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASS}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
    volumes:
      - ./notification-service/logs:/app/logs
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres-notification:
        condition: service_healthy
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # RabbitMQ - Message Broker para comunicación asíncrona
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # Puerto AMQP
      - "15672:15672" # Puerto Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
      - RABBITMQ_DEFAULT_VHOST=/
      - RABBITMQ_NODENAME=rabbit@rabbitmq
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - rabbitmq-logs:/var/log/rabbitmq
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Base de datos PostgreSQL para Identity Service
  postgres-identity:
    image: postgres:15-alpine
    container_name: postgres-identity
    restart: unless-stopped
    environment:
      - POSTGRES_DB=identity_db
      - POSTGRES_USER=${IDENTITY_DB_USER}
      - POSTGRES_PASSWORD=${IDENTITY_DB_PASS}
    volumes:
      - postgres-identity-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Base de datos PostgreSQL para Submission Service
  postgres-submission:
    image: postgres:15-alpine
    container_name: postgres-submission
    restart: unless-stopped
    environment:
      - POSTGRES_DB=submission_db
      - POSTGRES_USER=${SUBMISSION_DB_USER}
      - POSTGRES_PASSWORD=${SUBMISSION_DB_PASS}
    volumes:
      - postgres-submission-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Base de datos PostgreSQL para Notification Service
  postgres-notification:
    image: postgres:15-alpine
    container_name: postgres-notification
    restart: unless-stopped
    environment:
      - POSTGRES_DB=notification_db
      - POSTGRES_USER=${NOTIFICATION_DB_USER}
      - POSTGRES_PASSWORD=${NOTIFICATION_DB_PASS}
    volumes:
      - postgres-notification-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - trabajo-grado-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  trabajo-grado-network:
    driver: bridge

volumes:
  rabbitmq-data:
    driver: local
  rabbitmq-logs:
    driver: local
  submission-uploads:
    driver: local
  postgres-identity-data:
    driver: local
  postgres-submission-data:
    driver: local
  postgres-notification-data:
    driver: local
